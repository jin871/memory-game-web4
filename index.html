<!-- <head> や <style> はそのままでOK、<script> の中身だけ以下に置き換え -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA0D7fOnIvQFU3O29q6bb_6gj5tWN23N0s",
  authDomain: "memory-game-10e98.firebaseapp.com",
  databaseURL: "https://memory-game-10e98-default-rtdb.firebaseio.com",
  projectId: "memory-game-10e98",
  storageBucket: "memory-game-10e98.appspot.com",
  messagingSenderId: "435852264433",
  appId: "1:435852264433:web:63cdbef6f7742b34b13a50",
  measurementId: "G-FRDGGQNEZY"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let roomRef;
let localPlayerIndex;
let playerNames = [];
const totalPlayers = 4;
const aiPlayers = [];

async function startGame() {
  const mode = prompt("新しくルームを作成 → 1\n既存ルームに参加 → 2");

  let roomId;
  if (mode === "1") {
    roomId = "room_" + Math.random().toString(36).substring(2, 8);
    document.getElementById("roomDisplay").textContent = `ルーム名: ${roomId}`;
    localPlayerIndex = parseInt(prompt("あなたのプレイヤー番号（0〜3）を入力"));
    if (isNaN(localPlayerIndex) || localPlayerIndex < 0 || localPlayerIndex >= totalPlayers) localPlayerIndex = 0;

    for (let i = 0; i < totalPlayers; i++) {
      playerNames[i] = prompt(`プレイヤー${i}の名前を入力してください`) || `プレイヤー${i}`;
      if (!playerNames[i]) playerNames[i] = `プレイヤー${i}`;
    }
    for (let i = playerNames.length; i < totalPlayers; i++) {
      playerNames[i] = `AI${i}`;
      aiPlayers.push(i);
    }

    roomRef = ref(db, `rooms/${roomId}`);
    resetGame();

  } else if (mode === "2") {
    roomId = prompt("参加したいルームIDを入力してください（例: room_xxxxx）");
    roomRef = ref(db, `rooms/${roomId}`);
    const snapshot = await get(roomRef);
    if (!snapshot.exists()) {
      alert("ルームが見つかりません");
      return;
    }
    const state = snapshot.val();
    document.getElementById("roomDisplay").textContent = `参加中: ${roomId}`;
    playerNames = state.playerNames || [];
    aiPlayers.length = 0;
    for (let i = playerNames.length; i < totalPlayers; i++) aiPlayers.push(i);

    localPlayerIndex = parseInt(prompt("あなたのプレイヤー番号（0〜3）を入力"));
    if (isNaN(localPlayerIndex) || localPlayerIndex < 0 || localPlayerIndex >= totalPlayers) localPlayerIndex = 0;
  } else {
    alert("1または2を選んでください");
    return;
  }

  onValue(roomRef, (snapshot) => {
    const state = snapshot.val();
    if (state) {
      renderGame(state);
      if (aiPlayers.includes(state.currentPlayer)) aiPlay(state);
    }
  });
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function resetGame() {
  const numbers = [...Array(18).keys()].flatMap(n => [n, n]);
  shuffle(numbers);
  const cards = numbers.map(num => ({ num, flipped: false, matched: false }));

  set(roomRef, {
    cards,
    currentPlayer: 0,
    scores: [0, 0, 0, 0],
    flippedIndices: [],
    playerCount: totalPlayers,
    playerNames: playerNames
  });
}

function renderGame(state) {
  const gameBoard = document.getElementById("gameBoard");
  const playersDiv = document.getElementById("players");
  const turnInfo = document.getElementById("turnInfo");

  gameBoard.innerHTML = "";
  state.cards.forEach((card, index) => {
    const div = document.createElement("div");
    div.className = "card";
    if (card.matched) div.classList.add("matched");
    else if (card.flipped) div.classList.add("flipped");

    div.textContent = (card.flipped || card.matched) ? card.num : "";
    div.onclick = () => handleCardClick(index, state);
    gameBoard.appendChild(div);
  });

  playersDiv.innerHTML = "";
  for (let i = 0; i < totalPlayers; i++) {
    const name = state.playerNames?.[i] || `プレイヤー${i}`;
    const p = document.createElement("div");
    p.textContent = `${name}: ${state.scores[i]}点` + (i === state.currentPlayer ? " ←" : "");
    playersDiv.appendChild(p);
  }

  turnInfo.textContent = `現在のターン: ${state.playerNames?.[state.currentPlayer]}`;
}

function handleCardClick(index, state) {
  if (state.currentPlayer !== localPlayerIndex) return;
  if (state.cards[index].flipped || state.cards[index].matched) return;

  const flipped = Array.isArray(state.flippedIndices) ? state.flippedIndices : [];
  if (flipped.length >= 2) return;

  const newCards = [...state.cards];
  const newFlipped = [...flipped, index];
  newCards[index].flipped = true;

  update(roomRef, {
    cards: newCards,
    flippedIndices: newFlipped
  });

  if (newFlipped.length === 2) {
    setTimeout(() => {
      const [i1, i2] = newFlipped;
      const match = newCards[i1].num === newCards[i2].num;

      if (match) {
        newCards[i1].matched = true;
        newCards[i2].matched = true;
        state.scores[state.currentPlayer] += 1;
      } else {
        newCards[i1].flipped = false;
        newCards[i2].flipped = false;
        state.currentPlayer = (state.currentPlayer + 1) % totalPlayers;
      }

      update(roomRef, {
        cards: newCards,
        currentPlayer: state.currentPlayer,
        scores: state.scores,
        flippedIndices: []
      });
    }, 1000);
  }
}

function aiPlay(state) {
  const aiMemory = new Map();
  const knownPairs = new Map();

  state.cards.forEach((card, i) => {
    if (!card.matched && !card.flipped) {
      const existing = aiMemory.get(card.num);
      if (existing !== undefined) {
        knownPairs.set(card.num, [existing, i]);
      } else {
        aiMemory.set(card.num, i);
      }
    }
  });

  let choice1, choice2;
  if (knownPairs.size > 0) {
    const [_, [i1, i2]] = knownPairs.entries().next().value;
    choice1 = i1;
    choice2 = i2;
  } else {
    const candidates = state.cards.map((_, i) => i).filter(i => !state.cards[i].flipped && !state.cards[i].matched);
    shuffle(candidates);
    [choice1, choice2] = candidates.slice(0, 2);
  }

  setTimeout(() => handleCardClick(choice1, state), 500);
  setTimeout(() => handleCardClick(choice2, state), 1500);
}

startGame();
</script>
